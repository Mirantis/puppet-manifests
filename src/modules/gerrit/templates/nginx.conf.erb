proxy_cache_path /var/lib/nginx/cache/gerrit levels=1:2 keys_zone=gerrit_static:8m max_size=1000m inactive=600m;

server {
  listen 80;
  server_name <%= @service_fqdn %>:80;

  return 301 https://<%= @service_fqdn %>$request_uri;
}

server {
  listen 443;
  server_name <%= @service_fqdn %>:443;

  add_header Strict-Transport-Security max-age=15768000;

  location / {
    proxy_pass              http://127.0.0.1:8081;
    proxy_redirect          off;
    proxy_read_timeout      120;
    proxy_set_header        X-Forwarded-For $remote_addr;
	  proxy_set_header        Host $host;
  }

  location ~* \.cache\.(html|gif|png|css|jar|swf|js)$ {
    proxy_cache             gerrit_static;
    proxy_cache_min_uses    1;
    proxy_cache_use_stale   timeout;
    proxy_cache_valid       any 60m;
    proxy_ignore_headers    Cache-Control;
    proxy_ignore_headers    Expires;
    proxy_ignore_headers    Set-Cookie;
    proxy_ignore_headers    X-Accel-Expires;
    proxy_pass              http://127.0.0.1:8081;
    proxy_redirect          off;
    proxy_read_timeout      120;
    proxy_set_header        X-Forwarded-For $remote_addr;
    proxy_set_header        Host $host;
  }

  ssl                       on;
  ssl_certificate           <%= @ssl_cert_file %>;
  ssl_certificate_key       <%= @ssl_key_file %>;
  ssl_ciphers               ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;
  ssl_prefer_server_ciphers On;
  ssl_protocols             SSLv3 TLSv1 TLSv1.1 TLSv1.2;
  ssl_session_cache         shared:SSL:1m;
  ssl_session_timeout       5m;
}
