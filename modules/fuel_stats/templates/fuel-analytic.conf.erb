server {
    server_name <%= @fqdn %>;
    listen <%= @service_port %><% if @ssl %> ssl<% end %>;

    access_log /var/log/nginx/analytic.access.log proxy;
    error_log /var/log/nginx/analytic.error.log;

    <%- if @ssl -%>
    ssl                       on;
    ssl_certificate           <%= @ssl_cert_file %>;
    ssl_certificate_key       <%= @ssl_key_file %>;
    ssl_ciphers               EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH:EDH+aRSA:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS:!RC4;
    ssl_prefer_server_ciphers on;
    ssl_protocols             TLSv1 TLSv1.1 TLSv1.2;
    ssl_session_cache         shared:SSL:10m;
    ssl_session_timeout       10m;
    ssl_stapling              on;
    ssl_stapling_verify       on;
    <%- end -%>

    location ~ ^(/fuel)?(/[0-9A-Za-z_]+)?/(_count|_search) {
        <%- if @firewall_enable -%>
        <%- if @firewall_allow_sources != {} -%>
        <%- @firewall_allow_sources.each { |ip| -%>
        <%= "allow #{ip[1]["source"]};" %>
        <%- } -%>
        deny all;
        <%- elsif @firewall_allow_sources != {} -%>
        <%- @firewall_deny_sources.each { |ip| -%>
        <%= "allow #{ip[1]["source"]};" %>
        <%- } -%>
        allow all;
        <%- end -%>
        <%- end -%>
        expires -1;
        proxy_pass http://127.0.0.1:9200;
    }

    location / {
        <%- if @firewall_enable -%>
        <%- if @firewall_allow_sources != {} -%>
        <%- @firewall_allow_sources.each { |ip| -%>
        <%= "allow #{ip[1]["source"]};" %>
        <%- } -%>
        deny all;
        <%- elsif @firewall_allow_sources != {} -%>
        <%- @firewall_deny_sources.each { |ip| -%>
        <%= "allow #{ip[1]["source"]};" %>
        <%- } -%>
        allow all;
        <%- end -%>
        <%- end -%>
        expires -1;
        root <%= @www_root %>;
    }
}

<%- if @ssl -%>
server {
  server_name <%= @fqdn %>;
  listen 80;
  rewrite ^ https://$server_name:<%= @service_port %>$request_uri? permanent;
}
<%- end -%>
